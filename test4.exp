#!/usr/bin/expect -f
# Автоматические тесты для клиент-серверного приложения
# Требует установки: sudo apt-get install expect

set timeout 10
set test_passed 0
set test_failed 0
set total_tests 0

# Цвета для вывода
proc print_header {text} {
    puts "\n=========================================="
    puts "  $text"
    puts "==========================================\n"
}

proc print_test {num total name} {
    puts -nonewline "\[$num/$total\] $name... "
    flush stdout
}

proc test_passed {msg} {
    global test_passed
    incr test_passed
    puts "PASSED - $msg"
}

proc test_failed {msg} {
    global test_failed
    incr test_failed
    puts "FAILED - $msg"
}

# Конфигурация путей к исполняемым файлам
set SERVER_BIN "./build/server"
set CLIENT_BIN "./build/client"

# Проверка наличия исполняемых файлов
proc check_binaries {} {
    global SERVER_BIN CLIENT_BIN
    
    if {![file exists $SERVER_BIN]} {
        puts "ОШИБКА: Не найден исполняемый файл сервера: $SERVER_BIN"
        puts "Пожалуйста, скомпилируйте проект: make"
        exit 1
    }
    
    if {![file exists $CLIENT_BIN]} {
        puts "ОШИБКА: Не найден исполняемый файл клиента: $CLIENT_BIN"
        puts "Пожалуйста, скомпилируйте проект: make"
        exit 1
    }
}

# Функция для запуска сервера
proc start_server {port protocol} {
    global server_pid SERVER_BIN
    spawn $SERVER_BIN $port $protocol
    set server_pid $spawn_id
    expect {
        "Сервер запущен" { return 1 }
        timeout { return 0 }
    }
}

# Функция для остановки сервера
proc stop_server {} {
    global server_pid
    if {[info exists server_pid]} {
        close -i $server_pid
        wait -i $server_pid
        unset server_pid
    }
    sleep 1
}

# Создание тестовых файлов
proc create_test_files {} {
    # Граф с 5 вершинами (меньше минимума)
    set fp [open "test_graph_5v.txt" w]
    puts $fp "A B"
    puts $fp "B C"
    puts $fp "C D"
    puts $fp "D E"
    puts $fp "E A"
    close $fp
    
    # Граф с 6 вершинами (минимум)
    set fp [open "test_graph_6v.txt" w]
    puts $fp "A B, B C, C D, D E, E F, F A"
    close $fp
    
    # Граф с 13 вершинами (середина ОДЗ)
    set fp [open "test_graph_13v.txt" w]
    puts $fp "A B, B C, C D, D E, E F, F G"
    puts $fp "G H, H I, I J, J K, K L, L M, M A"
    close $fp
    
    # Граф с 20 вершинами (максимум)
    set fp [open "test_graph_20v.txt" w]
    puts $fp "A B, B C, C D, D E, E F, F G, G H, H I, I J, J K"
    puts $fp "K L, L M, M N, N O, O P, P Q, Q R, R S, S T, T A"
    close $fp
    
    # Граф с 21 вершиной (больше максимума)
    set fp [open "test_graph_21v.txt" w]
    puts $fp "A B, B C, C D, D E, E F, F G, G H, H I, I J, J K"
    puts $fp "K L, L M, M N, N O, O P, P Q, Q R, R S, S T, T U, U A"
    close $fp
}

# Удаление тестовых файлов
proc cleanup_test_files {} {
    file delete -force test_graph_5v.txt
    file delete -force test_graph_6v.txt
    file delete -force test_graph_13v.txt
    file delete -force test_graph_20v.txt
    file delete -force test_graph_21v.txt
}

#######################################################################################
# ТЕСТ 4: UDP при недоступности сервера
#################################################################################
proc test_udp_server_unavailable {} {
    global total_tests CLIENT_BIN
    incr total_tests
    print_test $total_tests 15 "UDP: Работа при недоступности сервера"
    
    # Сервер НЕ запускается!
    spawn $CLIENT_BIN 127.0.0.1 udp 9999
    expect "Соединение с сервером установлено"
    
    send "A B, B C, C A\r"
    expect "Введите начальную и конечную вершины"
    send "A C\r"
    
    expect {
        "Потеряна связь с сервером" {
            test_passed "Клиент корректно обработал недоступность сервера"
            send "exit\r"
            expect eof
            return
        }
        "Не удалось получить ответ от сервера" {
            test_passed "Клиент корректно обработал отсутствие ответа"
            send "exit\r"
            expect eof
            return
        }
        timeout {
            test_failed "Клиент не обнаружил недоступность сервера"
        }
    }
}

###############################################################################################################
# ГЛАВНАЯ ФУНКЦИЯ
#################################################################################################

print_header "АВТОМАТИЧЕСКОЕ ТЕСТИРОВАНИЕ"

# Проверка наличия исполняемых файлов
check_binaries
puts "Исполняемые файлы найдены\n"

# Создание тестовых файлов
puts "Создание тестовых файлов..."
create_test_files
puts "Тестовые файлы созданы\n"

# Запуск всех тестов
test_udp_server_unavailable

# Очистка
puts "\nОчистка тестовых файлов..."
cleanup_test_files
puts "Очистка завершена"

# Итоговый отчёт
print_header "РЕЗУЛЬТАТЫ ТЕСТИРОВАНИЯ"
puts "Всего тестов:  $total_tests"
puts "Успешно:       $test_passed "
puts "Неудачно:      $test_failed "

if {$test_failed == 0} {
    puts "\nВСЕ ТЕСТЫ ПРОЙДЕНЫ УСПЕШНО!"
    exit 0
} else {
    puts "\nЕСТЬ НЕУДАЧНЫЕ ТЕСТЫ"
    exit 1
}
