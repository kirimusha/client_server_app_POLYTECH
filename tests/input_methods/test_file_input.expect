#!/usr/bin/expect -f
set timeout 8
set port 18500

send "\r"
send_user "\rВвод из файла\r"
send "\r"

set filename "test_graph_real.txt"
set filedata "A B, B C, C D, D E, E F, F G"

exec /bin/bash -c "echo '$filedata' > $filename"

spawn ../bin/server $port tcp
set server [exp_pid]

set timeout 3
expect {
    "Сервер запущен" {
        set timeout 5
    }
    timeout {
        file delete $filename
        exit 1
    }
}

spawn ../bin/client 127.0.0.1 tcp $port

send "$filename\r"
after 1000
send "A D\r"

set timeout 5
expect {
    -re "Результат:.*" {
        set result 0
    }
    -re "Ошибка.*файл" {
        set result 1
    }
    timeout {
        set result 1
    }
}

send "exit\r"
after 300
exec kill -TERM $server 2>/dev/null
file delete $filename

exit $result