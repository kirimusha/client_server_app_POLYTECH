# Makefile –¥–ª—è —Å–±–æ—Ä–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ –∏ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
PROJECT_ROOT := $(shell pwd)
BUILD_DIR = $(PROJECT_ROOT)/build
TESTS_DIR = $(PROJECT_ROOT)/tests
COMMON_DIR = $(PROJECT_ROOT)/common
UTILS_DIR = $(PROJECT_ROOT)/utils
SERVER_DIR = $(PROJECT_ROOT)/server
CLIENT_DIR = $(PROJECT_ROOT)/client

# –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã
SERVER_SOURCES = \
	$(SERVER_DIR)/Server.cpp \
	$(SERVER_DIR)/ServerMain.cpp \
	$(COMMON_DIR)/Graph.cpp \
	$(COMMON_DIR)/Protocol.cpp \
	$(COMMON_DIR)/UDPProtocol.cpp \
	$(COMMON_DIR)/Dijkstra.cpp \
	$(UTILS_DIR)/FileReader.cpp \
	$(UTILS_DIR)/InputParser.cpp \
	$(UTILS_DIR)/Validator.cpp \
	$(UTILS_DIR)/Logger.cpp

CLIENT_SOURCES = \
	$(CLIENT_DIR)/Client.cpp \
	$(CLIENT_DIR)/ClientMain.cpp \
	$(COMMON_DIR)/Graph.cpp \
	$(COMMON_DIR)/Protocol.cpp \
	$(COMMON_DIR)/UDPProtocol.cpp \
	$(COMMON_DIR)/Dijkstra.cpp \
	$(UTILS_DIR)/FileReader.cpp \
	$(UTILS_DIR)/InputParser.cpp \
	$(UTILS_DIR)/Validator.cpp \
	$(UTILS_DIR)/Logger.cpp

# –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–µ —Ñ–∞–π–ª—ã
SERVER_BIN = $(BUILD_DIR)/server
CLIENT_BIN = $(BUILD_DIR)/client

BINARIES = $(SERVER_BIN) $(CLIENT_BIN)

# –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä
CXX = g++
CXXFLAGS = -Wall -Wextra -std=c++17 -I$(COMMON_DIR) -I$(UTILS_DIR) -I$(SERVER_DIR) -I$(CLIENT_DIR)
LDFLAGS = -pthread -lm

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED = \033[0;31m
GREEN = \033[0;32m
YELLOW = \033[1;33m
BLUE = \033[0;34m
PURPLE = \033[0;35m
CYAN = \033[0;36m
NC = \033[0m

.PHONY: all build test clean help run-server run-client kill-server check-structure

all: build test

# –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
build: $(BINARIES)

$(SERVER_BIN): $(SERVER_SOURCES)
	@echo "$(BLUE)üî® –ö–æ–º–ø–∏–ª—è—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞...$(NC)"
	@mkdir -p $(BUILD_DIR)
	@$(CXX) $(CXXFLAGS) $(SERVER_SOURCES) -o $@ $(LDFLAGS)
	@echo "$(GREEN)‚úÖ –°–µ—Ä–≤–µ—Ä —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω: $@$(NC)"

$(CLIENT_BIN): $(CLIENT_SOURCES)
	@echo "$(BLUE)üî® –ö–æ–º–ø–∏–ª—è—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞...$(NC)"
	@mkdir -p $(BUILD_DIR)
	@$(CXX) $(CXXFLAGS) $(CLIENT_SOURCES) -o $@ $(LDFLAGS)
	@echo "$(GREEN)‚úÖ –ö–ª–∏–µ–Ω—Ç —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω: $@$(NC)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞
check-structure:
	@echo "$(CYAN)üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞...$(NC)"
	@echo "–ö–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞: $(PROJECT_ROOT)"
	@echo "–¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(shell pwd)"
	@test -d $(COMMON_DIR) || (echo "$(RED)‚ùå –ü–∞–ø–∫–∞ common –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $(COMMON_DIR)$(NC)" && exit 1)
	@test -d $(UTILS_DIR) || (echo "$(RED)‚ùå –ü–∞–ø–∫–∞ utils –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $(UTILS_DIR)$(NC)" && exit 1)
	@test -d $(SERVER_DIR) || (echo "$(RED)‚ùå –ü–∞–ø–∫–∞ server –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $(SERVER_DIR)$(NC)" && exit 1)
	@test -d $(CLIENT_DIR) || (echo "$(RED)‚ùå –ü–∞–ø–∫–∞ client –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $(CLIENT_DIR)$(NC)" && exit 1)
	@echo "$(GREEN)‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞$(NC)"

# –ë—ã—Å—Ç—Ä—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
check:
	@echo "$(CYAN)üîç –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã...$(NC)"
	@if [ -d ../common ]; then \
		echo "$(GREEN)‚úÖ –ü–∞–ø–∫–∞ common –Ω–∞–π–¥–µ–Ω–∞$(NC)"; \
	else \
		echo "$(RED)‚ùå –ü–∞–ø–∫–∞ common –Ω–µ –Ω–∞–π–¥–µ–Ω–∞$(NC)"; \
		exit 1; \
	fi
	@if [ -d ../server ]; then \
		echo "$(GREEN)‚úÖ –ü–∞–ø–∫–∞ server –Ω–∞–π–¥–µ–Ω–∞$(NC)"; \
	else \
		echo "$(RED)‚ùå –ü–∞–ø–∫–∞ server –Ω–µ –Ω–∞–π–¥–µ–Ω–∞$(NC)"; \
		exit 1; \
	fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
check-sources:
	@echo "$(CYAN)üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤...$(NC)"
	@for file in $(SERVER_SOURCES); do \
		if [ -f $$file ]; then \
			echo "  ‚úÖ $$file"; \
		else \
			echo "$(YELLOW)  ‚ö†Ô∏è  –§–∞–π–ª $$file –Ω–µ –Ω–∞–π–¥–µ–Ω$(NC)"; \
		fi \
	done
	@echo ""
	@for file in $(CLIENT_SOURCES); do \
		if [ -f $$file ]; then \
			echo "  ‚úÖ $$file"; \
		else \
			echo "$(YELLOW)  ‚ö†Ô∏è  –§–∞–π–ª $$file –Ω–µ –Ω–∞–π–¥–µ–Ω$(NC)"; \
		fi \
	done
	@echo "$(GREEN)‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞$(NC)"

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Å–±–æ—Ä–∫–µ
prepare: check-structure check-sources
	@echo "$(GREEN)üöÄ –ì–æ—Ç–æ–≤ –∫ —Å–±–æ—Ä–∫–µ!$(NC)"

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
test: build
	@echo "$(PURPLE)üß™ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Å—Ç–æ–≤...$(NC)"
	@cd $(TESTS_DIR) && ./run_tests.sh

# –ó–∞–ø—É—Å–∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã —Ç–µ—Å—Ç–æ–≤
test-protocols: build
	@echo "$(PURPLE)üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤...$(NC)"
	@cd $(TESTS_DIR) && bash -c 'source utils.sh && print_section "–¢–ï–°–¢–´ –ü–†–û–¢–û–ö–û–õ–û–í"'
	@cd $(TESTS_DIR) && for test in protocols/*.expect; do \
		echo "–ó–∞–ø—É—Å–∫ $$test..."; \
		expect $$test && echo "$(GREEN)‚úì PASSED$${NC}" || echo "$(RED)‚úó FAILED$${NC}"; \
	done

test-validation: build
	@echo "$(PURPLE)üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏...$(NC)"
	@cd $(TESTS_DIR) && bash -c 'source utils.sh && print_section "–¢–ï–°–¢–´ –í–ê–õ–ò–î–ê–¶–ò–ò"'
	@cd $(TESTS_DIR) && for test in validation/*.expect; do \
		echo "–ó–∞–ø—É—Å–∫ $$test..."; \
		expect $$test && echo "$(GREEN)‚úì PASSED$${NC}" || echo "$(RED)‚úó FAILED$${NC}"; \
	done

test-input: build
	@echo "$(PURPLE)üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –≤–≤–æ–¥–∞...$(NC)"
	@cd $(TESTS_DIR) && bash -c 'source utils.sh && print_section "–¢–ï–°–¢–´ –í–í–û–î–ê"'
	@cd $(TESTS_DIR) && for test in input_methods/*.expect; do \
		echo "–ó–∞–ø—É—Å–∫ $$test..."; \
		expect $$test && echo "$(GREEN)‚úì PASSED$${NC}" || echo "$(RED)‚úó FAILED$${NC}"; \
	done

# –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç (—Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏)
quick-test: build
	@echo "$(PURPLE)üß™ –ó–∞–ø—É—Å–∫ –±—ã—Å—Ç—Ä—ã—Ö —Ç–µ—Å—Ç–æ–≤...$(NC)"
	@cd $(TESTS_DIR) && \
		expect protocols/test_tcp_basic.expect && \
		expect protocols/test_udp_basic.expect && \
		expect validation/test_graph_at_min.expect && \
		expect validation/test_graph_at_max.expect

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ TCP
run-server-tcp: build
	@echo "$(BLUE)üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ (TCP, –ø–æ—Ä—Ç 8080)...$(NC)"
	@$(SERVER_BIN) 8080 tcp

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ UDP
run-server-udp: build
	@echo "$(BLUE)üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ (UDP, –ø–æ—Ä—Ç 12345)...$(NC)"
	@$(SERVER_BIN) 12345 udp

# –ó–∞–ø—É—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞ TCP
run-client-tcp: build
	@echo "$(CYAN)üöÄ –ó–∞–ø—É—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞ (TCP, localhost:8080)...$(NC)"
	@$(CLIENT_BIN) 127.0.0.1 tcp 8080

# –ó–∞–ø—É—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞ UDP
run-client-udp: build
	@echo "$(CYAN)üöÄ –ó–∞–ø—É—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞ (UDP, localhost:12345)...$(NC)"
	@$(CLIENT_BIN) 127.0.0.1 udp 12345

# –£–±–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–µ—Ä—ã
kill-server:
	@echo "$(YELLOW)üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤...$(NC)"
	@pkill -f "$(SERVER_BIN)" 2>/dev/null || true
	@sleep 1
	@echo "$(GREEN)‚úÖ –í—Å–µ —Å–µ—Ä–≤–µ—Ä—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã$(NC)"

# –û—Ç–ª–∞–¥–æ—á–Ω–∞—è —Å–±–æ—Ä–∫–∞
debug: CXXFLAGS += -g -O0 -DDEBUG
debug: clean build
	@echo "$(GREEN)üîß –û—Ç–ª–∞–¥–æ—á–Ω–∞—è —Å–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞$(NC)"

# –†–µ–ª–∏–∑–Ω–∞—è —Å–±–æ—Ä–∫–∞
release: CXXFLAGS += -O3 -DNDEBUG
release: clean build
	@echo "$(GREEN)üöÄ –†–µ–ª–∏–∑–Ω–∞—è —Å–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞$(NC)"

# –û—á–∏—Å—Ç–∫–∞
clean:
	@echo "$(YELLOW)üßπ –û—á–∏—Å—Ç–∫–∞...$(NC)"
	@rm -rf $(BUILD_DIR)
	@cd $(TESTS_DIR) && rm -rf test_files results_*.log summary_*.txt 2>/dev/null || true
	@echo "$(GREEN)‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞$(NC)"

# –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç—á–µ—Ç
report:
	@echo "$(BLUE)üìä –ü–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç—á–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:$(NC)"
	@ls -t $(TESTS_DIR)/summary_*.txt 2>/dev/null | head -1 | xargs cat 2>/dev/null || echo "$(YELLOW)üì≠ –û—Ç—á–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã$(NC)"

# –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞
ls:
	@echo "$(BLUE)üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:$(NC)"
	@find . -maxdepth 3 -type d | sort | sed 's|^\./||'

# –°–ø—Ä–∞–≤–∫–∞
help:
	@echo "$(BLUE)üìñ –î–û–°–¢–£–ü–ù–´–ï –ö–û–ú–ê–ù–î–´:$(NC)"
	@echo ""
	@echo "$(GREEN)üì¶ –°–±–æ—Ä–∫–∞:$(NC)"
	@echo "  make               - –°–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã"
	@echo "  make build         - –¢–æ–ª—å–∫–æ —Å–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞"
	@echo "  make prepare       - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ —Ñ–∞–π–ª—ã"
	@echo "  make debug         - –û—Ç–ª–∞–¥–æ—á–Ω–∞—è —Å–±–æ—Ä–∫–∞"
	@echo "  make release       - –†–µ–ª–∏–∑–Ω–∞—è —Å–±–æ—Ä–∫–∞"
	@echo "  make clean         - –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–æ–µ–∫—Ç"
	@echo ""
	@echo "$(PURPLE)üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:$(NC)"
	@echo "  make test          - –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã"
	@echo "  make test-protocols - –¢–µ—Å—Ç—ã –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤ (TCP/UDP)"
	@echo "  make test-validation - –¢–µ—Å—Ç—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–æ–≤"
	@echo "  make test-input    - –¢–µ—Å—Ç—ã –º–µ—Ç–æ–¥–æ–≤ –≤–≤–æ–¥–∞"
	@echo "  make quick-test    - –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã"
	@echo "  make report        - –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç—á–µ—Ç"
	@echo ""
	@echo "$(CYAN)üöÄ –ó–∞–ø—É—Å–∫:$(NC)"
	@echo "  make run-server-tcp - –ó–∞–ø—É—Å—Ç–∏—Ç—å TCP —Å–µ—Ä–≤–µ—Ä (–ø–æ—Ä—Ç 8080)"
	@echo "  make run-server-udp - –ó–∞–ø—É—Å—Ç–∏—Ç—å UDP —Å–µ—Ä–≤–µ—Ä (–ø–æ—Ä—Ç 12345)"
	@echo "  make run-client-tcp - –ó–∞–ø—É—Å—Ç–∏—Ç—å TCP –∫–ª–∏–µ–Ω—Ç"
	@echo "  make run-client-udp - –ó–∞–ø—É—Å—Ç–∏—Ç—å UDP –∫–ª–∏–µ–Ω—Ç"
	@echo "  make kill-server   - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–µ—Ä—ã"
	@echo ""
	@echo "$(YELLOW)üõ†Ô∏è  –£—Ç–∏–ª–∏—Ç—ã:$(NC)"
	@echo "  make check-structure - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞"
	@echo "  make check          - –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞"
	@echo "  make ls             - –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É"
	@echo "  make help          - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"